
<html lang="en">

<head>
  <title>Network</title>




    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">




  <style type="text/css">
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0px;
        padding: 0px;
        background-color: #222222;
      }

      #mynetwork {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1;
      }

      .overlay {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 2;
        pointer-events: none;
      }
      .Button1, .Button2, .searchTextbox, input[type="button"] {
        position: absolute;
        z-index: 2;
        pointer-events: auto;
      }

      .searchTextbox {
        top: 10px;
        left: 10px;
        width: 400px;
        height: 36px;
      }

      .idleButton {
        top: 10px;
        left: 420px;
        width: 100px;
        height: 36px;
      }

      .sniffButton {
        top: 10px;
        left: 530px;
        width: 100px;
        height: 36px;
      }

      .loadingOverlay {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        background-color:#222222;
        opacity: 1;
        z-index: 3;
      }
      
      .progress {
        position:absolute;
        top:50%;
        left:10%;
        width:80%;
        z-index: 8;
      }

    .scrolled-dropdown {
        max-height: 200px;
        overflow-y: auto;
    }



  </style>
</head>
<body data-bs-theme="dark">

<div class="loadingOverlay">
    <div class="progress">
        <div class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
</div>

<div id="mynetwork"></div>

<div class="overlay">
    <div>
        <div class="form-group searchTextbox">
            <input type="text" id="myAutocomplete" autocomplete="off" class="form-control bg-secondary text-light" />
        </div>


        <input class="idleButton btn btn-secondary" type="button" onclick="setMode('idle');" value="Idle" >
        <input class="sniffButton btn btn-secondary" type="button" onclick="setMode('sniff');" value="Sniff">
    </div>
</div> 





    <!-- Dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <!-- Bootstrap 4 Autocomplete -->
    <script src="../static/js/bs4-autocomplete.min.js" crossorigin="anonymous"></script>
    
    
    
      <script src="../static/js/socket.io.js"></script>
      <script src="../static/js/vis-network.min.js"></script>




<script type="text/javascript">


    var DIR = "../static/img/"
    var network,nodes,edges; 

    //Just to test if it works
    const ssid = ["DTUsecure", "DTUGuest", "test5"];

    //Funtion to fetch the network from json, to visualize
    function fetchData(ssid) {
        fetch('static/data/' + ssid + '.json') 
        .then(response => response.json())
        .then(data => {
    
        })
        .catch(error => console.error("Error", error));
    }

    function addOptionsToDatalist(optionValue) {
        for (let i=0;i<optionValue.length;i++){
            dropdownMenuNodes.push({label:optionValue[i],value:optionValue[i]});
            console.log("Adding:"+optionValue[i]);
        }
    }


    // Funtion for visualizing when a client is pressed on
    function deauth_attack(target_mac) {
        var node_data = nodes.get(target_mac);

        console.log("checking: " + node_data);
        if (node_data.color == 'OrangeRed') {
            node_data.color = null; 
            console.log('stopping deauthentication: ' + node_data.id);
            socket.emit("setMode", {'mode':'idle'});
        }    
        else {
            node_data.color = 'OrangeRed'; 
            console.log('Deauthenticating: ' + node_data.id);
            socket.emit("setMode", {'mode':'deauth_attack','target':node_data.id});
        }

        nodes.update(node_data);
    }

    function csa_attack(target_mac){
        var node_data = nodes.get(target_mac);

        console.log("checking: " + node_data);
        if (node_data.color == 'OrangeRed') {
            node_data.color = null; 
            console.log('stopping deauthentication: ' + node_data.id);
            socket.emit("setMode", {'mode':'idle'});
        }    
        else {
            node_data.color = 'OrangeRed'; 
            console.log('Deauthenticating: ' + node_data.id);
            socket.emit("setMode", {'mode':'csa_attack','target':node_data.id});
        }

        nodes.update(node_data);
    }


        //Literally does nothing rn
    function focusSelect(item) {
        var options = {
            scale: 1.5,
            animation: {
                duration: 1000,
                easingFunction: 'easeInOutQuad'
            },
        };
        network.unselectAll()
        network.selectNodes([item.label]);
        network.focus(item.label, options);
    }


    const socket = io();
    $(document).ready(function() {});

    socket.on("connect", () => {
        console.log("connected");
    });

    socket.on("disconnect", () => {
        console.log("disconnected");
    });

    function setMode(mode) {
        if (mode == "idle"){
            console.log("Setting idle");
            socket.emit("setMode", {'mode':'idle'});
        }
        else if (mode == "sniff"){
            console.log("Setting sniff");
            socket.emit("setMode", {'mode':'sniff','clear':true});
        }
        
    }

    socket.on("initGraph", function(msg) {
        console.log("initGraph");
        var parsedMsg = JSON.parse(msg);

        if (parsedMsg.nodes.length == 0 && parsedMsg.edges.length == 0){
            setProgressBar("100%");
        }
        else {
            nodes = new vis.DataSet(parsedMsg.nodes);
            edges = new vis.DataSet(parsedMsg.edges);
            network.setData({nodes:nodes,edges:edges})

            let ids = parsedMsg.nodes.map(object => object.id);
            console.log(ids);
            addOptionsToDatalist(ids);
        }

    });

    socket.on("addToGraph", function(msg) {
        console.log("addToGraph");
        var parsedMsg = JSON.parse(msg);
        nodes.add(parsedMsg.nodes);
        edges.add(parsedMsg.edges);
        let ids = parsedMsg.nodes.map(object => object.id);
        addOptionsToDatalist(ids);
    });

    socket.on("clearGraph", function(msg) {
        console.log("clearGraph");
        nodes.clear();
        edges.clear();
        while(dropdownMenuNodes.length > 0) {
            dropdownMenuNodes.pop();
        }
    });



    var datalist = document.getElementById("list-nodes");
    nodes = new vis.DataSet();
    edges = new vis.DataSet();
    var container = document.getElementById("mynetwork");
    var networkData = { nodes: nodes, edges: edges };
    var options = {
        nodes: {  
            shapeProperties: {
                useImageSize: true,
                useBorderWithImage: false,
                interpolation: false,
                coordinateOrigin: "center"
            }
        },
        edges: {
            color: {
                color: "#848484"
            }
        },
        interaction: {
            hover: true
        },
        groups: {
            ssid: {
                color: "HotPink",
            },
            client: {
                color: "Orange",
            },
            ap: { 
                color: "LightBlue" 
            }
        },
    };

    network = new vis.Network(container, networkData, options);

    network.on("doubleClick", function (params) {
        console.log(params);
        if (params.nodes.length == 1 ) {
            let target_mac = params.nodes[0]
            let node_data = nodes.get(target_mac);
            // Perform standard deauth attack if client is selected
            if (node_data.group == "client"){
                deauth_attack(target_mac);
            } 
            // Perform CSA attack if AP is selected
            else if(node_data.group == "ap"){
                console.log("AAAAA");
                csa_attack(target_mac);
            } 
        }
    });  

    network.on("stabilizationProgress", function (params) {
        console.log("stabilizationProgress")
        var percentage = Math.round((params.iterations / params.total)*100)+"%";
        setProgressBar(percentage);

    });

    network.once("stabilizationIterationsDone", function () {
        setProgressBar("100%");
    });

    function setProgressBar(percentage){
        $(".progress-bar").css('width', percentage);
        if (percentage=="100%"){
            setTimeout(function () {
                $(".loadingOverlay").css('opacity',0);
                $(".loadingOverlay").css('display',"none");
            },1000);
        }
    }


</script>


<script>


    dropdownMenuNodes = [{ label: "init", value: "init" }];
    $('#myAutocomplete').autocomplete({
        source: dropdownMenuNodes,
        treshold: 1,
        maximumItems: 10,
        highlightClass: 'text-danger',
        dropdownClass: 'scrolled-dropdown',
        onSelectItem:focusSelect
    });

</script>
</body>

</html>
